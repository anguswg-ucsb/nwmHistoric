---
title: "NWM"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { icon: "fa-question-circle", href: "https://ufokn.com/", align: right }
    theme: flatly
    orientation: row
    vertical_layout: fill
---

```{r setup, include = FALSE}
library(shiny)
library(flexdashboard)
library(shinycustomloader)

library(dataRetrieval)
library(nhdplusTools)
library(nwmHistoric)
library(tidycensus)

library(lubridate)

library(leaflet)
library(sf)
library(ggplot2)
library(dplyr)
library(dygraphs)
library(DT)
library(formattable)



source('../nwm_shiny/helper.R')
```

```{r context="server"}
#Initialize Maps 
output$catchMap     <- renderLeaflet({ basemap() })
output$catchMap_2     <- renderLeaflet({ second_map() })
output$countyMap <- renderLeaflet({ pop_map(pop) })

comid <<- reactiveValues(comid = NULL)
# 
# pop <<- get_acs(geography = "county",
#                  variables = "B01003_001",
#                  geometry = TRUE)
#   
#   pop$area <- st_area(pop)
#   
#   pop$area <- units::set_units(pop$area, "mi^2")
#   pop <- rename(pop, population = estimate)
#   pop <- pop %>%
#     mutate(pop_density = population/area)
#   pop <- pop %>% filter(!grepl("^02", GEOID))
#   pop <- pop %>% filter(!grepl("^15", GEOID))
#   pop <<- st_transform(pop, 4326)

# get_nwm <- reactive({
#   if(is.null(comid)) {
#     NULL
#   } else {
#   comid <- isolate(comid)
#   nwm <- readNWMdata(comid = comid)
#   print("test")
#   nwm <- head(nwm, 10)
#   nwm
#   }
# })
```



NWM {data-icon="fa-tint"}
=====================================

Inputs {.sidebar}
-------------------------------------

### Model Filters
```{r}
dateRangeInput("dateTS", label = "Date Range Input",
               start = "1993-01-01",
               end = "2018-12-31",
               format = "yyyy mm dd",
               weekstart = 1)
verbatimTextOutput("dateTSText")
htmlOutput("areaTable")
```

### **Submit**
```{r}
shiny::actionButton("dateButton", label = "Enter", icon("search"))
```

```{r context = "server"}
observeEvent(input$catchTS_date_window, {
  start <- as.Date(ymd_hms(input$catchTS_date_window[[1]]))
  stop  <- as.Date(ymd_hms(input$catchTS_date_window[[2]]))
  updateDateRangeInput(session = session,
                       inputId = "dateTS",
                       start = start,end = stop
                       )
})

update_range <- eventReactive(input$dateButton, {
      range <- paste(input$dateTS[1], input$dateTS[2], sep = "/")
      return(ts[range])
    })

# observeEvent(input$dateButton, {
#   
#     nwm <- readNWMdata(comid = comid)
#     ts = xts::xts(as.data.frame(nwm <- nwm$flow_cms), order.by = nwm <- nwm$dateTime, tz= 'UTC')
#       
# 
#     
#     
#     output$catchTS <- renderDygraph({
# 
#       dygraph(update_range)  %>%
#         dyHighlight(highlightCircleSize = 2,
#                 highlightSeriesBackgroundAlpha = .3) %>%
#         dyOptions(colors = c("darkcyan"),
#               fillGraph = TRUE) %>%
#         dyRangeSelector(dateWindow = c(as.character(input$dateTS[1]), as.character(input$dateTS[2])))
#     })
#   
# })
```

Row 
-----------------------------------------------------------------------
### 
```{r}
valueBoxOutput("comidBox")
```

Row 
-----------------------------------------------------------------------
### Draw
```{r}
leafletOutput("catchMap")
```

```{r context = "server"}


 lat = 35.6643
lng = -96.91935

 pt <- data.frame(lat, lng)
   pt <- sf::st_as_sf(pt,
                        coords = c("lng", "lat"),
                        crs = 4326)
       nldi <- findNLDI(location = pt)

   
  

# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + info panel
  observeEvent(input$catchMap_click, {
   if(!is.null(input$catchMap_click)) {
    click <<- input$catchMap_click %>% 
      data.frame() %>% 
      dplyr::select(lat,lng)
    print(click)
    pt <- sf::st_as_sf(click, 
                        coords = c("lng", "lat"), 
                        crs = 4326)
  
    nldi <- findNLDI(location = pt)
    comid = nldi$comid
    
    print(comid)
    print("map1_click2")
    # 
    # catch_df <- get_nhdplus(comid = comid, realization = "catchment")
    
    bb <- st_bbox(nldi) # current bounding box
    
    # bounding box range
    xrange <- bb$xmax - bb$xmin # range of x values
    yrange <- bb$ymax - bb$ymin # range of y values
    
    # expand bb by 60% 
    bb[1] <- bb[1] - (0.6 * xrange) # xmin - left
    bb[3] <- bb[3] + (0.6 * xrange) # xmax - right
    bb[2] <- bb[2] - (0.6 * yrange) # ymin - bottom
    bb[4] <- bb[4] + (0.6 * yrange) # ymax - top

    # make bb a sfc
    bb <- bb %>%  # take the bounding box ...
        st_as_sfc() 
    
    catch_df <- get_nhdplus(AOI = bb, realization = "catchment")
   
    
    output$comidBox <- renderValueBox({
    valueBox(value = paste("COMID: ", comid),
      icon = "fa-id-badge",
      color = "primary") })
    output$comidBox2 <- renderValueBox({
    valueBox(value = paste("COMID: ", comid),
      icon = "fa-id-badge",
      color = "primary") })

    leafletProxy("catchMap") %>% 
      clearMarkers() %>%
      clearShapes() %>% 
      addMarkers(data = pt,
                 layerId = ~comid,) %>% 
      addPolygons( data = catch_df,
                   col = 'blue') 
      # zoom_to_catch(catch_df, comid)
    
    leafletProxy("catchMap_2") %>%
      clearMarkers() %>%
      clearShapes() %>%
      addMarkers(data = pt,
                 layerId = ~comid) %>%
      addPolygons( data = catch_df,
                   col = 'blue')
    leafletProxy("catchMap_3") %>% 
      clearMarkers() %>%
      clearShapes() %>% 
      addMarkers(data = pt) %>% 
      addPolygons( data = catch_df,
                   layerId = ~comid,
                   col = 'blue')
  
    output$areaTable <- renderText ({ make_table2(comid) })
    output$catchDT <- renderDataTable({ make_table(comid) })
   } 
})

# catchMap and catchMap_2 are linked while zooming
  observe({ # Observer to respond to zoom / pan of map1 and apply to map2
    coords <- input$catchMap_center
    zoom <- input$catchMap_zoom
    print(coords)
    print(zoom)
    if (!is.null(coords)) {
      leafletProxy("catchMap_2") %>%
        setView(lat = coords$lat, lng = coords$lng, zoom = zoom)
    }
})
```

Row 
-----------------------------------------------------------------------
### Time series
```{r}
dygraphOutput("catchTS")
```

### Map 2
```{r}
leafletOutput("catchMap_2")
```

```{r context = "server"}
# testing reactivity with date range input & button
dateTSText <- eventReactive(input$dateButton, {
  paste0("'", as.character(input$dateTS[1]), "/", as.character(input$dateTS[2]), "'")
 
  })
  
  output$dateTSText <- renderText({
   dateTSText()
  })
```


```{r context = "server"}
observeEvent(input$catchMap_click, {
    # pt <<- NULL
    click <<- input$catchMap_click %>%
      data.frame() %>%
      dplyr::select(lat,lng)
    print(click)
    pt <- sf::st_as_sf(click,
                        coords = c("lng", "lat"),
                        crs = 4326)
    nldi <- findNLDI(location = pt)
    #
    comid <- nldi$comid
    nwm <- readNWMdata(comid = comid)


    output$catchTS <- renderDygraph({
        print("map1_click")
        make_ts4(nwm)
  })
})
```

Data Table {data-orientation=columns data-icon="fa-filter"}
=====================================

Inputs {.sidebar}
-------------------------------------
### Model Filters
```{r}
# sliderInput("hour_table", dates$nwm_date_range$local_tz[1], value = 0, min = 0, max = 23, step = 1)
shiny::actionButton("button_table", label = "Submit Query", icon("search"))
```


Column {data-width=600}
-----------------------------------------------------------------------
### 
```{r}
valueBoxOutput("comidBox2")
```

### Data table
```{r}
# `r renderText({ values$display })`
dataTableOutput("catchDT")
```

### Population density
```{r}
leafletOutput("countyMap")
```

```{r context = "server"}
# pop <- get_acs(geography = "county",
#                      variables = "B01003_001",
#                      geometry = TRUE)
# 
# pop$area <- st_area(pop)
# 
# pop$area <- units::set_units(pop$area, "mi^2")
# pop <- rename(pop, population = estimate)
# pop <- pop %>%
#   mutate(pop_density = population/area)
# pop <- pop %>% filter(!grepl("^02", GEOID))
# pop <- pop %>% filter(!grepl("^15", GEOID))
# pop <- st_transform(pop, 4326)
# 
# pal <- colorQuantile(palette = "viridis", domain = pop$pop_density, n = 10)
#intersect clicked catchment with county polygons


# 
#   observeEvent(input$catchMap_3_click , {
#     click <<- input$catchMap_3_click %>% 
#             data.frame() %>% 
#             dplyr::select(lat,lng)
#     
#           print(click)
#     pt <- sf::st_as_sf(click, 
#                         coords = c("lng", "lat"), 
#                         crs = 4326)
#   
#   
#     nldi <- findNLDI(comid = comid)
#    
#     nldi <- st_transform(nldi, 5070)
# 
#     buff <- st_buffer(nldi, 50000) %>% 
#           st_transform(4326)
#     overlap_counties <- st_filter(pop, buff, .predicate = st_intersects)
#     
#     output$countyMap <- renderLeaflet({ pop_map(overlap_counties) })
# 
# 
# })



```


Column {data-width=800}
-----------------------------------------------------------------------
### Map 3
```{r}
leafletOutput("catchMap_3") 
```

```{r context = "server"}
# load polygons when map 3 is clicked
output$catchMap_3 <- renderLeaflet({ basemap() })
  observeEvent(input$catchMap_3_click, {
    # pt <<- NULL
    click <<- input$catchMap_3_click %>% 
      data.frame() %>% 
      dplyr::select(lat,lng)
    
    print(click)
    pt <- sf::st_as_sf(click, 
                        coords = c("lng", "lat"), 
                        crs = 4326)
  
  
    nldi <- findNLDI(location = pt)
    
    comid = nldi$comid
    
    print(comid)
    output$catchTS <- renderDygraph({ make_ts(pt) })

    output$comidBox2 <- renderValueBox({
      valueBox(value = paste("COMID: ", comid),
        icon = "fa-water",
        color = "success") })
    output$comidBox <- renderValueBox({
      valueBox(value = paste("COMID: ", comid),
        icon = "fa-water",
        color = "success") })
    
    print("map3_click1")
    # output$areaTable <- renderText({ make_table2(comid) })
    # # 
    # catch_df <- get_nhdplus(comid = comid, realization = "catchment")
    
    bb <- st_bbox(nldi) # current bounding box
    
    # bounding box range
    xrange <- bb$xmax - bb$xmin # range of x values
    yrange <- bb$ymax - bb$ymin # range of y values
    
    # expand bb by 60% 
    bb[1] <- bb[1] - (0.6 * xrange) # xmin - left
    bb[3] <- bb[3] + (0.6 * xrange) # xmax - right
    bb[2] <- bb[2] - (0.6 * yrange) # ymin - bottom
    bb[4] <- bb[4] + (0.6 * yrange) # ymax - top

    # make bb a sfc
    bb <- bb %>%  # take the bounding box ...
        st_as_sfc() 
    
    catch_df <- get_nhdplus(AOI = bb, realization = "catchment")
  
    leafletProxy("catchMap_3") %>% 
      clearMarkers() %>%
      clearShapes() %>% 
      addMarkers(data = pt) %>% 
      addPolygons( data = catch_df,
                   layerId = ~comid,
                   col = 'blue')
    leafletProxy("catchMap") %>%
      clearMarkers() %>%
      clearShapes() %>%
      addMarkers(data = pt) %>%
      addPolygons( data = catch_df,
                   layerId = ~comid,
                   col = 'blue')
    leafletProxy("catchMap_2") %>%
      clearMarkers() %>%
      clearShapes() %>%
      addMarkers(data = pt,
                 layerId = ~comid) %>%
      addPolygons( data = catch_df,
                   col = 'blue')
})

```

```{r context = "server"}

# Clicking map 3, outputs data table on page 2 + Timeseries on page 1
  observeEvent(input$catchMap_3_click, {
    # pt <<- NULL
    click <<- input$catchMap_3_click %>%
      data.frame() %>%
      dplyr::select(lat,lng)

    print(click)
    pt <- sf::st_as_sf(click,
                        coords = c("lng", "lat"),
                        crs = 4326)


    nldi <- findNLDI(location = pt)

    comid = nldi$comid
    print(comid)

    output$catchDT <- renderDataTable({ make_table(comid) })

    nwm <- readNWMdata(comid = comid)
    output$catchTS      <- renderDygraph( {make_ts4(nwm) })
})
```
























